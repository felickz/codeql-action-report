name: 'CodeQL SARIF Report'
description: 'Generate and upload SARIF HTML reports from CodeQL analysis'
author: 'felickz'
branding:
  icon: 'file-text'
  color: 'blue'

inputs:
  sarif-input:
    description: 'Path to the SARIF output directory. Defaults to CODEQL_ACTION_SARIF_RESULTS_OUTPUT_DIR environment variable set by codeql-action.'
    required: false

runs:
  using: 'composite'
  steps:
    - name: Install sarif-tools
      shell: bash
      run: |
        pip install -r ${{ github.action_path }}/requirements.txt

    - name: Set environment variables
      shell: bash
      run: |
        REPO_NAME="$(echo '${{ github.repository }}' | tr '/' '-')"
        echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV

    - name: Generate SARIF HTML reports
      shell: bash
      env:
        INPUT_SARIF_DIR: ${{ inputs.sarif-input }}
      run: |
        SARIF_DIR="$INPUT_SARIF_DIR"
        if [ -z "$SARIF_DIR" ]; then
          SARIF_DIR="${CODEQL_ACTION_SARIF_RESULTS_OUTPUT_DIR}"
        fi

        if [ -z "$SARIF_DIR" ]; then
          echo "Error: No SARIF directory specified and CODEQL_ACTION_SARIF_RESULTS_OUTPUT_DIR is not set"
          exit 1
        fi

        if [ ! -d "$SARIF_DIR" ]; then
          echo "Error: SARIF directory not found: $SARIF_DIR"
          exit 1
        fi

        FOUND_FILES=0
        while IFS= read -r -d '' SARIF_FILE; do
          BASENAME=$(basename "$SARIF_FILE" .sarif)
          echo "Generating HTML report for $SARIF_FILE"
          sarif html --output "./sarif_${BASENAME}.html" --no-autotrim "$SARIF_FILE"
          FOUND_FILES=1
        done < <(find "$SARIF_DIR" -maxdepth 1 -name "*.sarif" -type f -print0)

        if [ "$FOUND_FILES" -eq 0 ]; then
          echo "No .sarif files found in $SARIF_DIR"
          exit 1
        fi

    - name: Upload SARIF HTML reports
      id: upload-sarif-html
      uses: actions/upload-artifact@v5
      with:
        name: ${{ env.REPO_NAME }}-${{github.sha}}-sarif-html-reports
        path: sarif_*.html
        if-no-files-found: warn

    - name: Copy SARIF files to workspace
      shell: bash
      env:
        INPUT_SARIF_DIR: ${{ inputs.sarif-input }}
      run: |
        SARIF_DIR="$INPUT_SARIF_DIR"
        if [ -z "$SARIF_DIR" ]; then
          SARIF_DIR="${CODEQL_ACTION_SARIF_RESULTS_OUTPUT_DIR}"
        fi

        # Copy SARIF files to current directory for upload
        if [ -d "$SARIF_DIR" ]; then
          cp "$SARIF_DIR"/*.sarif . 2>/dev/null || true
        fi

    - name: Upload SARIF files
      id: upload-sarif
      uses: actions/upload-artifact@v5
      with:
        name: ${{ env.REPO_NAME }}-${{github.sha}}-sarif
        path: "*.sarif"
        if-no-files-found: warn

    - name: Generate SBOM
      id: generate-sbom
      continue-on-error: true
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Attempting to fetch SBOM from GitHub API..."
        TEMP_FILE="sbom-temp.json"
        ERROR_OUTPUT=$(gh api /repos/${{ github.repository }}/dependency-graph/sbom 2>&1 > "$TEMP_FILE")
        EXIT_CODE=$?

        if [ $EXIT_CODE -ne 0 ]; then
          echo "::error::API call failed with exit code $EXIT_CODE"
          echo "::error::Error details: $ERROR_OUTPUT"
          echo "::warning::Failed to generate SBOM. The dependency graph may not be enabled for this repository."
          echo "::warning::Check: Repository Settings > Security > Dependency graph must be enabled"
          exit 1
        fi

        # Extract the SBOM from the API response (it's nested in a "sbom" key)
        jq '.sbom' "$TEMP_FILE" > "sbom.spdx.json"
        rm "$TEMP_FILE"
        echo "SBOM generated successfully"

    - name: Upload SBOM
      id: upload-sbom
      if: steps.generate-sbom.outcome == 'success'
      uses: actions/upload-artifact@v5
      with:
        name: ${{ env.REPO_NAME }}-${{github.sha}}-sbom
        path: sbom.spdx.json
        if-no-files-found: warn

    - name: Attest Report and SARIF with SBOM
      id: attest-sbom
      if: steps.generate-sbom.outcome == 'success'
      uses: actions/attest-sbom@v3
      with:
        subject-path: sarif_*.html, *.sarif
        sbom-path: sbom.spdx.json
        show-summary: false # we report in the final summary

    - name: Attest Report and SARIF
      id: attest-provenance
      if: steps.generate-sbom.outcome != 'success'
      uses: actions/attest-build-provenance@v3
      with:
        subject-path: sarif_*.html, *.sarif
        show-summary: false # we report in the final summary

    - name: Generate CodeQL Scan Summary
      shell: bash
      env:
        INPUT_SARIF_DIR: ${{ inputs.sarif-input }}
        HTML_ARTIFACT_URL: ${{ steps.upload-sarif-html.outputs.artifact-url }}
        SARIF_ARTIFACT_URL: ${{ steps.upload-sarif.outputs.artifact-url }}
        SBOM_ARTIFACT_URL: ${{ steps.upload-sbom.outputs.artifact-url }}
        SBOM_ATTESTATION_URL: ${{ steps.attest-sbom.outputs.attestation-url }}
        PROVENANCE_ATTESTATION_URL: ${{ steps.attest-provenance.outputs.attestation-url }}
        SBOM_GENERATED: ${{ steps.generate-sbom.outcome == 'success' && 'true' || 'false' }}
        GITHUB_REPO_OWNER: ${{ github.repository_owner }}
      run: |
        SARIF_DIR="$INPUT_SARIF_DIR"
        if [ -z "$SARIF_DIR" ]; then
          SARIF_DIR="${CODEQL_ACTION_SARIF_RESULTS_OUTPUT_DIR}"
        fi

        # Find SARIF files
        SARIF_FILES=($(find "$SARIF_DIR" -maxdepth 1 -name "*.sarif" -type f))
        SARIF_COUNT=${#SARIF_FILES[@]}

        if [ "$SARIF_COUNT" -eq 0 ]; then
          echo "No SARIF file found for summary generation"
          exit 0
        fi

        if [ "$SARIF_COUNT" -gt 1 ]; then
          echo "::warning::Multiple SARIF files found ($SARIF_COUNT). Summary generation for multiple files is not supported. Using the first file: ${SARIF_FILES[0]}"
        fi

        SARIF_FILE="${SARIF_FILES[0]}"
        BASENAME=$(basename "$SARIF_FILE" .sarif)
        HTML_FILENAME="sarif_${BASENAME}.html"
        SARIF_FILENAME=$(basename "$SARIF_FILE")
        SBOM_FILENAME="sbom.spdx.json"

        # Extract information from SARIF file
        CODEQL_VERSION=$(jq -r '.runs[0].tool.driver.semanticVersion // "N/A"' "$SARIF_FILE")

        # Extract language from automationDetails.id (format: "/language:actions/" -> "actions")
        CODEQL_LANGUAGE=$(jq -r '.runs[0].automationDetails.id // "N/A" |
          if . == "N/A" then "N/A"
          else gsub("^/language:"; "") | gsub("/$"; "") | ascii_upcase
          end' "$SARIF_FILE")

        # Find build mode from toolExecutionNotifications
        BUILD_MODE=$(jq -r '
          .runs[0].invocations[0].toolExecutionNotifications[] |
          select(.descriptor.id == "cli/build-mode") |
          .properties.attributes.buildMode // "N/A"
        ' "$SARIF_FILE")

        # Count extracted files (count notifications with this ID pattern for any language)
        EXTRACTED_FILES=$(jq -r '
          [.runs[0].invocations[0].toolExecutionNotifications[] |
          select(.descriptor.id | contains("/diagnostics/successfully-extracted-files"))] | length
        ' "$SARIF_FILE")

        # Count detected files (count notifications with this ID pattern for any language)
        DETECTED_FILES=$(jq -r '
          [.runs[0].invocations[0].toolExecutionNotifications[] |
          select(.descriptor.id | startswith("cli/expected-extracted-files/"))] | length
        ' "$SARIF_FILE")

        # Get environment variables (with defaults if not set)
        ACTION_VERSION="${CODEQL_ACTION_VERSION:-N/A}"
        SCAN_STARTED="${CODEQL_WORKFLOW_STARTED_AT:-N/A}"
        ANALYSIS_KEY="${CODEQL_ACTION_ANALYSIS_KEY:-N/A}"

        # Generate markdown summary
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # :shield: CodeQL Scan Summary - ${CODEQL_LANGUAGE}

        ## Scan Information
        | Property | Value |
        |----------|-------|
        | **GitHub Repository** | \`${{ github.repository }}\` |
        | **Ref** | \`${{ github.ref }}\` |
        | **Commit SHA** | \`${{ github.sha }}\` |
        | **Triggered By** | \`${{ github.event_name }}\` |
        | **Runner Environment** | \`${{ runner.environment }}\` |
        | **CodeQL Language** | \`${CODEQL_LANGUAGE}\` |
        | **CodeQL Build Mode** | \`${BUILD_MODE}\` |
        | **CodeQL CLI Version** | \`${CODEQL_VERSION}\` |
        | **CodeQL Action Version** | \`${ACTION_VERSION}\` |
        | **CodeQL Analysis Category** | \`${ANALYSIS_KEY}\` |
        | **CodeQL Scan Started** | ${SCAN_STARTED} |


        ## Analysis Metrics
        | Metric | Count |
        |--------|-------|
        | **Detected Files** | ${DETECTED_FILES} |
        | **Extracted Files** | ${EXTRACTED_FILES} |

        ## ðŸ“¦ Artifacts
        - ðŸ“Š [HTML Report](${HTML_ARTIFACT_URL}) - \`${HTML_FILENAME}\`
        - ðŸ“„ [SARIF File](${SARIF_ARTIFACT_URL}) - \`${SARIF_FILENAME}\`
        - ðŸ“‹ [SBOM](${SBOM_ARTIFACT_URL:-N/A}) - \`${SBOM_FILENAME}\`

        ## ðŸ” Attestations
        EOF

        # Add attestation info based on which was generated
        if [ "${SBOM_GENERATED}" = "true" ]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        - âœ… [SBOM Attestation](${SBOM_ATTESTATION_URL})

        **Verify Attestations:**
        \`\`\`bash
        # Verify HTML report with SBOM attestation SPDX predicate
        gh attestation verify --owner ${GITHUB_REPO_OWNER} --predicate-type "https://spdx.dev/Document/v2.3" ${HTML_FILENAME}

        # Verify SARIF file with SBOM attestation SPDX predicate
        gh attestation verify --owner ${GITHUB_REPO_OWNER} --predicate-type "https://spdx.dev/Document/v2.3" ${SARIF_FILENAME}
        \`\`\`
        EOF
        else
          cat >> $GITHUB_STEP_SUMMARY << EOF
        - âœ… [Build Provenance Attestation](${PROVENANCE_ATTESTATION_URL})

        **Verify Attestations:**
        \`\`\`bash
        # Verify HTML report with build provenance
        gh attestation verify --owner ${GITHUB_REPO_OWNER} ${HTML_FILENAME}

        # Verify SARIF file with build provenance
        gh attestation verify --owner ${GITHUB_REPO_OWNER} ${SARIF_FILENAME}
        \`\`\`
        EOF
        fi

        cat >> $GITHUB_STEP_SUMMARY << EOF

        ---
        *Generated on $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
        EOF

        echo "âœ… CodeQL scan summary generated successfully"